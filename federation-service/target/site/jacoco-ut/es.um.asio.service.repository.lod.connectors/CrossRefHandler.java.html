<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CrossRefHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Archetype - Java JPA Rest API - Service</a> &gt; <a href="index.source.html" class="el_package">es.um.asio.service.repository.lod.connectors</a> &gt; <span class="el_source">CrossRefHandler.java</span></div><h1>CrossRefHandler.java</h1><pre class="source lang-java linenums">package es.um.asio.service.repository.lod.connectors;

import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import es.um.asio.service.config.LodDataSet;
import es.um.asio.service.model.TripleObjectLink;
import es.um.asio.service.model.TripleObjectSimplified;
import es.um.asio.service.service.impl.TextHandlerServiceImp;
import es.um.asio.service.util.Utils;
import org.jsoup.Connection;
import org.springframework.stereotype.Repository;

import java.io.UnsupportedEncodingException;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.*;

@Repository
<span class="fc" id="L20">public class CrossRefHandler implements LODHandler {</span>

    public static final String DATASET = &quot;CROSSREF&quot;;

    @Override
    public Set&lt;TripleObjectLink&gt; findLink(TripleObjectSimplified tos, LodDataSet.Dataset dataset, TextHandlerServiceImp textHandlerService) {
<span class="nc" id="L26">        Set&lt;TripleObjectLink&gt; result = new HashSet&lt;&gt;();</span>
        try {
<span class="nc" id="L28">            boolean isCompleted = false;</span>
<span class="nc" id="L29">            LodDataSet.Dataset prunedDataset =</span>
<span class="nc" id="L30">                    dataset.getPrunedDatasetSortedFilteredByConnectionType(</span>
<span class="nc" id="L31">                            Arrays.asList(new LodDataSet.Dataset.Connection.ConnectionType [] {</span>
                                    LodDataSet.Dataset.Connection.ConnectionType.API
                            }
                            )
                    );
<span class="nc bnc" id="L36" title="All 2 branches missed.">            for (LodDataSet.Dataset.Connection con : prunedDataset.getConnections()) {</span>
<span class="nc" id="L37">                result = handleAPIRequest(con,tos, textHandlerService);</span>
<span class="nc" id="L38">                return result;</span>
            }
<span class="nc" id="L40">        } catch (CloneNotSupportedException e) {</span>
<span class="nc" id="L41">            e.printStackTrace();</span>
<span class="nc" id="L42">        }</span>

<span class="nc" id="L44">        return result;</span>
    }

    private Set&lt;TripleObjectLink&gt; handleAPIRequest(LodDataSet.Dataset.Connection con, TripleObjectSimplified tos,TextHandlerServiceImp textHandlerService) {
<span class="nc" id="L48">        Set&lt;TripleObjectLink&gt; results = new HashSet&lt;&gt;();</span>
        try {
<span class="nc" id="L50">            LodDataSet.Dataset.Connection connection = con.getPrunedConnectionByTripleObjectSimplified(tos);</span>
<span class="nc" id="L51">            String apiKey = connection.getApiKey();</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">            for (LodDataSet.Dataset.Connection.Mapping mapping : connection.getSortedMappings()) {</span>
<span class="nc" id="L53">                URL url = buildURL(Arrays.asList(new String[] {</span>
<span class="nc" id="L54">                        connection.getBaseURL(),</span>
<span class="nc" id="L55">                        mapping.getSuffixURL()</span>
                }));
<span class="nc bnc" id="L57" title="All 2 branches missed.">                for (LodDataSet.Dataset.Connection.Mapping.LocalClass lc : mapping.getLocalClasses()) {</span>
<span class="nc" id="L58">                    List&lt;String&gt; localAttributes = lc.getAttributes();</span>
<span class="nc" id="L59">                    Object value = tos.getAttributeValue(tos.getAttributes(),localAttributes);</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">                    if (Utils.isPrimitive(value)) {</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">                        if (mapping.getParamType() == LodDataSet.Dataset.Connection.Mapping.ParamType.URI) {</span>
<span class="nc" id="L62">                            url = new URL(url.toURI().toString().replaceAll(&quot;\\$var\\$&quot;,value.toString()));</span>
                            try {
<span class="nc" id="L64">                                JsonElement jResponse = Utils.doRequest(url, Connection.Method.GET, null, null, null, true);</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">                                if (jResponse!=null) {</span>
<span class="nc" id="L66">                                    results = parseResultByDOI(tos,DATASET,con.getBaseURL(),mapping.getRemoteName(),lc.getName(),jResponse.getAsJsonObject(),lc.getMappers());</span>
<span class="nc bnc" id="L67" title="All 4 branches missed.">                                    if (results!=null &amp;&amp; results.size()&gt;0) {</span>
<span class="nc" id="L68">                                        return results;</span>
                                    }
                                }
<span class="nc" id="L71">                            } catch (Exception e) {</span>
<span class="nc" id="L72">                                continue;</span>
<span class="nc" id="L73">                            }</span>
                        }
                    } else {
                        continue;
                    }
<span class="nc" id="L78">                }</span>
<span class="nc" id="L79">            }</span>
<span class="nc" id="L80">        } catch (Exception e) {</span>
<span class="nc" id="L81">            e.printStackTrace();</span>
<span class="nc" id="L82">        }</span>
<span class="nc" id="L83">        return results;</span>
    }


    private String buildContentQuery(String remoteAttribute, String value, boolean isIdentifier, boolean removeStopwords,TextHandlerServiceImp textHandlerService) throws UnsupportedEncodingException {
<span class="nc bnc" id="L88" title="All 4 branches missed.">        if (!isIdentifier &amp;&amp; removeStopwords) {</span>
<span class="nc" id="L89">            value = value.replaceAll(&quot;-&quot;,&quot; &quot;);</span>
<span class="nc" id="L90">            value = textHandlerService.removeStopWords(value);</span>
<span class="nc" id="L91">            String [] chunks  = value.split(&quot;  *&quot;);</span>
<span class="nc" id="L92">            value = String.join(&quot; AND &quot;,value.split(&quot;  *&quot;));</span>
            //value = URLEncoder.encode(value, StandardCharsets.UTF_8);
        }
<span class="nc" id="L95">        String formatStr = String.format(&quot;%s(%s)&quot;, remoteAttribute, value);</span>
<span class="nc" id="L96">        return formatStr;</span>
    }

    private URL buildURL(List&lt;String&gt; urlChunks) throws MalformedURLException {
<span class="nc" id="L100">        StringBuffer sb = new StringBuffer();</span>
<span class="nc" id="L101">        List&lt;String&gt; urlCheckedChunks = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">        for (String chunk: urlChunks) {</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (!Utils.isValidString(chunk))</span>
<span class="nc" id="L104">                continue;</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">            if (chunk.startsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L106">                urlCheckedChunks.add(chunk.substring(1));</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">            } else if (chunk.endsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L108">                urlCheckedChunks.add(chunk.substring(0,chunk.length()-1));</span>
            } else {
<span class="nc" id="L110">                urlCheckedChunks.add(chunk);</span>
            }

<span class="nc" id="L113">        }</span>
<span class="nc" id="L114">        return new URL(String.join(&quot;/&quot;,urlCheckedChunks));</span>
    }

    private Set&lt;TripleObjectLink&gt; parseResultByDOI(TripleObjectSimplified tos,String datasetName, String baseURL, String remoteName, String localClassName, JsonObject jResponse, List&lt;LodDataSet.Dataset.Connection.Mapping.LocalClass.Mapper&gt; mappers) {
<span class="nc" id="L118">        Set&lt;TripleObjectLink&gt; tripleObjectLinks = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (jResponse.has(&quot;message&quot;)) {</span>

<span class="nc" id="L121">            JsonObject jMessage = jResponse.get(&quot;message&quot;).getAsJsonObject();</span>

<span class="nc" id="L123">            JsonObject jPrefixes = new JsonObject();</span>
<span class="nc" id="L124">            jPrefixes.addProperty(&quot;default&quot;,&quot;https://crossref.org/&quot;);</span>
<span class="nc" id="L125">            JsonArray jLinks = new JsonArray();</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">            if (jMessage!=null) {</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">                if (jMessage.has(&quot;link&quot;)) {</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">                    for (JsonElement jeLinks :jMessage.get(&quot;link&quot;).getAsJsonArray()) {</span>
<span class="nc" id="L129">                        JsonObject jLink = new JsonObject();</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">                        if (jeLinks.getAsJsonObject().has(&quot;intended-application&quot;)) {</span>
<span class="nc" id="L131">                            jLink.addProperty(&quot;type&quot;,jeLinks.getAsJsonObject().get(&quot;intended-application&quot;).getAsString());</span>
                        }
<span class="nc bnc" id="L133" title="All 2 branches missed.">                        if (jeLinks.getAsJsonObject().has(&quot;@URL&quot;)) {</span>
<span class="nc" id="L134">                            jLink.addProperty(&quot;link&quot;,jeLinks.getAsJsonObject().get(&quot;URL&quot;).getAsString());</span>
                        }
<span class="nc bnc" id="L136" title="All 2 branches missed.">                        if (jeLinks.getAsJsonObject().has(&quot;content-type&quot;)) {</span>
<span class="nc" id="L137">                            jLink.addProperty(&quot;content-type&quot;,jeLinks.getAsJsonObject().get(&quot;content-type&quot;).getAsString());</span>
                        }
<span class="nc bnc" id="L139" title="All 2 branches missed.">                        if (jeLinks.getAsJsonObject().has(&quot;content-version&quot;)) {</span>
<span class="nc" id="L140">                            jLink.addProperty(&quot;content-version&quot;,jeLinks.getAsJsonObject().get(&quot;content-version&quot;).getAsString());</span>
                        }
<span class="nc bnc" id="L142" title="All 2 branches missed.">                        if (jLink.size()&gt;0) {</span>
<span class="nc" id="L143">                            jLinks.add(jLink);</span>
                        }
<span class="nc" id="L145">                    }</span>
                }
            }
<span class="nc" id="L148">            jMessage.remove(&quot;link&quot;);</span>
<span class="nc" id="L149">            TripleObjectLink tol = new TripleObjectLink(datasetName,baseURL,remoteName,localClassName);</span>
<span class="nc" id="L150">            tol.setOrigin(tos);</span>
<span class="nc" id="L151">            tol.populatePrefixes(jPrefixes);</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">            if (jMessage.has(&quot;DOI&quot;))</span>
<span class="nc" id="L153">                tol.setId(jMessage.get(&quot;DOI&quot;).getAsString());</span>
<span class="nc" id="L154">            tol.populateMapper(mappers);</span>
<span class="nc" id="L155">            tol.populateLinks(jLinks);</span>
<span class="nc" id="L156">            tol.populateAttributes(removeDateParts(jMessage));</span>
<span class="nc" id="L157">            tripleObjectLinks.add(tol);</span>

        }
<span class="nc" id="L160">        return tripleObjectLinks;</span>
    }

    private JsonObject removeDateParts(JsonObject jObject) {
<span class="nc" id="L164">        JsonObject jObjectCopy = new JsonObject();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        for (Map.Entry&lt;String, JsonElement&gt; jAttr :jObject.entrySet()) {</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">            if (jAttr.getValue().isJsonPrimitive()) {</span>
<span class="nc" id="L167">                jObjectCopy.add(jAttr.getKey(),jAttr.getValue());</span>
            } else {
<span class="nc bnc" id="L169" title="All 2 branches missed.">                if (jAttr.getKey().contains(&quot;date-parts&quot;)) {</span>
<span class="nc" id="L170">                    continue;</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">                } else if (jAttr.getValue().isJsonObject()) {</span>
<span class="nc" id="L172">                    jObjectCopy.add(jAttr.getKey(),removeDateParts(jAttr.getValue().getAsJsonObject()));</span>
                } else { // Es una lista
<span class="nc" id="L174">                    jObjectCopy.add(jAttr.getKey(),jAttr.getValue());</span>
                }
            }
<span class="nc" id="L177">        }</span>
<span class="nc" id="L178">        return jObjectCopy;</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>